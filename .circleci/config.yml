version: 2

defaults: &defaults
  working_directory: ~/select
  docker:
    - image: thomashoneyman/purescript:0.0.2

jobs:
  test:
    <<: *defaults
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1.2-bower-cache-{{ arch }}-{{ .Branch }}-{{ checksum "bower.json" }}
            - v1.2-bower-cache-{{ arch }}-{{ .Branch }}
            - v1.2-bower-cache

      - restore_cache:
          keys:
            - v1.2-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
            - v1.2-npm-cache-{{ arch }}-{{ .Branch }}
            - v1.2-npm-cache

      - restore_cache:
          keys:
            - v1.2-build-cache

      - run:
          name: Install dependencies from NPM and Bower and compile...
          command: npm install

      - save_cache:
          key: v1.2-bower-cache-{{ arch }}-{{ .Branch }}-{{ checksum "bower.json" }}
          paths:
            - ~/select/bower_components

      - save_cache:
          key: v1.2-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - ~/select/node_modules

      - save_cache:
          key: v1.2-build-cache
          paths:
            - ~/select/output

      # Verify all examples successfully build...
      - run:
          name: Build all examples...
          command: npm run build-docs

      - run:
          name: Copy over files to keep
          command: mv docs/dist workspace

      # Persist the specified paths into the workspace
      - persist_to_workspace:
        # Must be an absolute path or relative from working_directory
          root: .
          paths:
            - docs

  docs:
    <<: *defaults
    steps:
      - checkout

      - run:
          name: Prepare branches
          command: |
            git checkout gh-pages
            git checkout master

      - run:
          name: Set up gh-pages for build artifacts
          command: |
            mkdir ../gh-pages
            git worktree add ../gh-pages gh-pages

      - attach_workspace:
          at: persisted_docs

      - run:
          name: Build CSS
          command: |
            npm run install-css
            npm run build-css
            mv docs/dist/select.css persisted_docs/dist/

      # Enable building docs
      - add_ssh_keys:
          fingerprints:
            - "bf:0e:a0:9d:37:6e:40:34:3c:72:90:f5:c8:93:cd:a5"

      - run:
          name: Build docs and push to GitHub
          command: |
            npm run build-all
            rm -rf ../gh-pages/dist
            mv persisted_docs/dist ../gh-pages/dist
            cd ../gh-pages
            git config --global user.email "automated@automated.com"
            git config --global user.name "CircleCI Auto Deploy"
            git commit --allow-empty -a -m "Docs build triggered by CircleCI"
            git push -u origin gh-pages

workflows:
  version: 2
  build:
    jobs:
      - test

      # On master branch, rebuild docs
      - docs:
          requires:
            - test

        # filters:
        #   branches:
        #     only: master
