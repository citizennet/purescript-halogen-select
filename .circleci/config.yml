version: 2

jobs:
    build:
        docker:
            - image: haskell:8.2
        steps:
            - checkout
            - restore_cache:
                keys:
                    - build-cache
                    - bower-cache-{{ arch }}-{{ .Branch }}-{{ checksum "bower.json" }}
                    - bower-cache-{{ arch }}-{{ .Branch }}
                    - bower-cache
                    - node-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
                    - node-cache-{{ arch }}-{{ .Branch }}
                    - node-cache
            - run:
                name: Build the project
                command: pulp build
            - save_cache:
                key: build-cache
                paths:
                    - ~/output
            - save_cache:
                key: bower-cache-{{ arch }}-{{ .Branch }}-{{ checksum "bower.json" }}
                paths:
                    - ~/bower_components
            - save_cache:
                key: node-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}
                paths:
                    - ~/node_modules

    # test:
    #     docker:
    #         - image: haskell:8.2
    #     steps:
    #         - checkout
    #         - restore_cache:
    #             keys:
    #                 - test-cache
    #                 - test-lib-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package.yaml" }}
    #                 - test-lib-cache-{{ arch }}-{{ .Branch }}
    #                 - test-lib-cache
    #         - run:
    #             name: Test the project
    #             command: stack test
    #         - save_cache:
    #             key: test-cache
    #             paths:
    #                 - ~/.ghc
    #                 - ~/.cabal
    #                 - ~/.stack
    #         - save_cache:
    #             key: test-lib-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package.yaml" }}
    #             paths:
    #                 - ~/.stack-work/install

workflows:
    version: 2
    build_and_test:
        jobs:
            - build
            # - test:
            #     requires:
            #       - build
